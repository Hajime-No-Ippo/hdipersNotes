<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flow States | flowstates.me</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0f172a;--muted:#94a3b8}
        body { background-color: var(--bg); color: #e2e8f0; overflow-x: hidden; }
        .font-serif-en { font-family: 'Lora', serif; }
        .font-serif-cn { font-family: 'Noto Serif SC', serif; }
        #flowCanvas { position: fixed; inset:0; width:100%; height:100%; z-index:-1; opacity:0.6; }
        .fade-in { animation: fadeIn 1.2s ease-out both; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:none} }
        a.post { text-decoration: none; }
        
        .tag-pill { transition: all 0.2s; }
        .tag-pill:hover { border-color: #34d399; color: #34d399; }
        
        /* Thumbnail Styles */
        .thumb-box {
            width: 80px; height: 80px; flex-shrink: 0; border-radius: 8px; 
            overflow: hidden; background: #1e293b; margin-left: 1rem;
            display: none; /* Hidden by default */
        }
        .thumb-box.has-img { display: block; }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: opacity 0.3s; }
        .post:hover .thumb-box img { opacity: 1; }
    </style>
</head>
<body class="antialiased selection:bg-emerald-500 selection:text-white">

<canvas id="flowCanvas" aria-hidden="true"></canvas>

<nav class="fixed top-0 w-full p-6 flex justify-between items-center z-50 backdrop-blur-md bg-slate-900/40 border-b border-slate-800/50">
    <div class="text-xl font-bold tracking-widest opacity-90 hover:text-emerald-400 transition cursor-pointer" onclick="window.location.reload()">flowstates.me</div>
    <button id="langToggle" class="px-4 py-1 border border-slate-500 rounded-full text-xs hover:bg-emerald-900/50 hover:border-emerald-400 transition uppercase tracking-wide">SWITCH TO 中文</button>
</nav>

<main class="min-h-screen w-full max-w-2xl mx-auto px-4 sm:px-6 pt-32 pb-20 relative z-10">
    <article class="fade-in mb-16 text-center">
        <h1 class="text-5xl sm:text-6xl font-bold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-teal-300 to-blue-300">
            <span class="content-en font-serif-en">Flow States</span>
            <span class="content-zh hidden font-serif-cn">心流时刻</span>
        </h1>
        <div class="space-y-4 text-lg sm:text-xl opacity-80 font-light max-w-lg mx-auto leading-relaxed">
            <p class="content-en font-serif-en">A digital garden dedicated to capturing the fleeting moments of absolute clarity and creation.</p>
            <p class="content-zh hidden font-serif-cn">一座数字花园，致力于捕捉那些绝对清醒与创造力的稍纵即逝的时刻。</p>
        </div>
    </article>

    <section id="blog-section" class="fade-in border-t border-slate-800 pt-10">
        <div class="flex justify-between items-end mb-8 px-2">
            <h2 class="text-xs uppercase tracking-[0.2em] text-emerald-500">
                <span class="content-en">Latest Logs</span>
                <span class="content-zh hidden">最新日志</span>
            </h2>
            <div id="filter-indicator" class="hidden text-xs flex items-center gap-2">
                <span class="opacity-60">Filtered by:</span>
                <span id="active-filter-name" class="text-emerald-400 font-bold border-b border-emerald-400"></span>
                <button onclick="clearFilter()" class="hover:text-red-400 ml-2 font-bold px-2" title="Clear Filter">✕</button>
            </div>
        </div>

        <div id="post-list" class="space-y-8">
            <div class="text-center opacity-50 text-sm italic py-10">
                <span class="content-en">Connecting to memory...</span>
                <span class="content-zh hidden">正在连接记忆...</span>
            </div>
        </div>
    </section>
</main>

<footer class="w-full text-center opacity-40 text-xs uppercase tracking-widest pb-8 relative z-10">22abad @ Ireland</footer>

<script>
let ALL_POSTS = []; 
const GITHUB_USERNAME = '22abad';
const GITHUB_REPO = 'hdipers-notes';
const POSTS_FOLDER = 'posts';

const toggleBtn = document.getElementById('langToggle');
let isEnglish = true;
function updateLang() {
    document.querySelectorAll('.content-en').forEach(el => el.classList.toggle('hidden', !isEnglish));
    document.querySelectorAll('.content-zh').forEach(el => el.classList.toggle('hidden', isEnglish));
    toggleBtn.textContent = isEnglish ? 'SWITCH TO 中文' : 'SWITCH TO ENGLISH';
}
toggleBtn.addEventListener('click', ()=>{ isEnglish = !isEnglish; updateLang(); });

function parseFrontMatter(raw){
    const result = {meta:{}, body: raw};
    const m = raw.match(/^---\s*([\s\S]*?)\s*---\s*/);
    if(!m) return result;
    const head = m[1]; const lines = head.split(/\r?\n/); let currentKey = null;
    lines.forEach(line => {
        if(!line.trim()) return;
        if(line.trim().startsWith('-') && currentKey) {
            let val = line.trim().replace(/^-\s*/, '').trim();
            if(/^['"].*['"]$/.test(val)) val = val.slice(1,-1);
            if(!Array.isArray(result.meta[currentKey])) result.meta[currentKey] = [];
            result.meta[currentKey].push(val);
        } else if(line.includes(':')) {
            const idx = line.indexOf(':'); const key = line.slice(0, idx).trim(); let val = line.slice(idx+1).trim(); currentKey = key;
            if(val) { if(/^['"].*['"]$/.test(val)) val = val.slice(1,-1); result.meta[key] = val; } else { result.meta[key] = []; }
        }
    });
    result.body = raw.slice(m[0].length); return result;
}

// Helper to extract first image from markdown body
function extractFirstImage(markdown) {
    const imgRegex = /!\[.*?\]\((.*?)\)/;
    const match = markdown.match(imgRegex);
    return match ? match[1] : null;
}

window.filterPosts = function(tag) {
    const filtered = ALL_POSTS.filter(p => {
        const cats = Array.isArray(p.categories) ? p.categories : [p.categories];
        const tags = Array.isArray(p.tags) ? p.tags : [p.tags];
        return cats.includes(tag) || tags.includes(tag);
    });
    document.getElementById('active-filter-name').textContent = tag;
    document.getElementById('filter-indicator').classList.remove('hidden');
    renderPosts(filtered);
}

window.clearFilter = function() {
    document.getElementById('filter-indicator').classList.add('hidden');
    renderPosts(ALL_POSTS);
}

function createPostCard(post){
    const card = document.createElement('div');
    card.className = 'post block group p-6 sm:p-8 rounded-xl bg-slate-800/30 hover:bg-slate-800/60 transition border border-slate-800 hover:border-slate-600 relative overflow-hidden shadow-sm hover:shadow-md';

    const linkOverlay = document.createElement('a');
    const id = encodeURIComponent(post.filename.replace(/\.md$/i,''));
    linkOverlay.href = `post.html?id=${id}`;
    linkOverlay.className = 'absolute inset-0 z-0';
    card.appendChild(linkOverlay);

    // Top Row
    const topRow = document.createElement('div');
    topRow.className = 'flex flex-wrap justify-between items-start mb-3 relative z-10 pointer-events-none gap-2';

    const cats = Array.isArray(post.categories) ? post.categories : (post.categories ? [post.categories] : []);
    if(cats.length > 0) {
        const badge = document.createElement('button');
        badge.className = 'text-[10px] uppercase tracking-widest px-2 py-1 rounded-full border border-emerald-500/30 text-emerald-400 bg-slate-900/50 backdrop-blur-sm hover:bg-emerald-900/30 hover:text-white transition cursor-pointer pointer-events-auto sm:absolute sm:top-0 sm:right-0 sm:mt-8 sm:mr-8';
        badge.textContent = cats[0];
        badge.onclick = (e) => { e.preventDefault(); e.stopPropagation(); window.filterPosts(cats[0]); };
        const badgeWrapper = document.createElement('div');
        badgeWrapper.appendChild(badge);
        topRow.appendChild(badgeWrapper);
    } else { topRow.appendChild(document.createElement('div')); }

    const mobileDate = document.createElement('div');
    mobileDate.className = 'text-xs font-mono opacity-40 mb-2 sm:hidden';
    mobileDate.textContent = post.date || '';
    card.appendChild(mobileDate);

    // Title
    const titleDiv = document.createElement('div');
    titleDiv.className = 'relative z-10 pointer-events-none pr-0 sm:pr-20';
    const h3 = document.createElement('h3');
    h3.className = 'text-xl sm:text-2xl font-serif-en group-hover:text-emerald-200 transition font-bold leading-tight text-slate-100 mb-3';
    const enTitle = document.createElement('span'); enTitle.className = 'content-en'; enTitle.textContent = post.title_en;
    const zhTitle = document.createElement('span'); zhTitle.className = 'content-zh hidden font-serif-cn'; zhTitle.textContent = post.title_zh || post.title_en;
    h3.appendChild(enTitle); h3.appendChild(zhTitle);
    titleDiv.appendChild(h3);
    card.appendChild(titleDiv);

    // Content Row (Summary + Thumbnail)
    const contentRow = document.createElement('div');
    contentRow.className = 'flex justify-between items-start relative z-10 pointer-events-none mb-5';

    // Summary
    const p = document.createElement('div'); 
    p.className = 'text-sm sm:text-base opacity-70 font-light leading-relaxed flex-1';
    const pEn = document.createElement('span'); pEn.className = 'content-en'; pEn.textContent = post.summary_en || '';
    const pZh = document.createElement('span'); pZh.className = 'content-zh hidden'; pZh.textContent = post.summary_zh || '';
    p.appendChild(pEn); p.appendChild(pZh);
    contentRow.appendChild(p);

    // Thumbnail (New Feature)
    const thumbBox = document.createElement('div');
    thumbBox.className = 'thumb-box';
    if (post.thumbnail) {
        thumbBox.classList.add('has-img');
        const img = document.createElement('img');
        img.src = post.thumbnail;
        thumbBox.appendChild(img);
    }
    contentRow.appendChild(thumbBox);
    card.appendChild(contentRow);

    // Tags
    const tags = Array.isArray(post.tags) ? post.tags : (post.tags ? [post.tags] : []);
    if(tags.length > 0) {
        const metaRow = document.createElement('div');
        metaRow.className = 'flex flex-wrap gap-2 mt-auto relative z-20';
        tags.forEach(t => {
            const span = document.createElement('button');
            span.onclick = (e) => { e.preventDefault(); e.stopPropagation(); window.filterPosts(t); };
            span.className = 'tag-pill text-[10px] uppercase tracking-wider px-2 py-1 border border-slate-700 text-slate-400 rounded hover:bg-slate-700 cursor-pointer pointer-events-auto';
            span.textContent = '#' + t;
            metaRow.appendChild(span);
        });
        card.appendChild(metaRow);
    }
    return card;
}

function renderPosts(postsToRender) {
    const listContainer = document.getElementById('post-list');
    listContainer.innerHTML = '';
    if(postsToRender.length === 0) {
        listContainer.innerHTML = '<div class="text-center opacity-50 py-10">No logs found.</div>'; return;
    }
    postsToRender.forEach(p => listContainer.appendChild(createPostCard(p)));
    updateLang();
}

async function loadData(){
    const listContainer = document.getElementById('post-list');
    try{
        const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${POSTS_FOLDER}`;
        const res = await fetch(apiUrl);
        if(!res.ok) throw new Error(res.status);
        const files = await res.json();
        const mdFiles = files.filter(f=>/\.md$/i.test(f.name));
        if(mdFiles.length===0){ listContainer.innerHTML = '<div class="text-center opacity-50">No logs found yet.</div>'; return; }

        ALL_POSTS = await Promise.all(mdFiles.map(async f=>{
            try{
                const txtRes = await fetch(f.download_url);
                if(!txtRes.ok) throw new Error('Failed');
                const text = await txtRes.text();
                const parsed = parseFrontMatter(text);
                const meta = parsed.meta || {};
                // Extract image from body
                const thumb = extractFirstImage(parsed.body);
                
                return {
                    filename: f.name,
                    title_en: meta.title_en || meta.title || f.name.replace(/\.md$/,''),
                    title_zh: meta.title_zh || '',
                    date: meta.date || '',
                    summary_en: meta.summary_en || meta.summary || '',
                    summary_zh: meta.summary_zh || '',
                    categories: meta.categories || [],
                    tags: meta.tags || [],
                    thumbnail: thumb // Store the extracted image URL
                };
            }catch(e){ return null; }
        }));
        ALL_POSTS = ALL_POSTS.filter(p => p !== null);
        ALL_POSTS.sort((a,b)=>{
            const da = a.date ? Date.parse(a.date) : 0;
            const db = b.date ? Date.parse(b.date) : 0;
            return (db - da) || a.filename.localeCompare(b.filename);
        });
        renderPosts(ALL_POSTS);
    }catch(err){
        console.error(err);
        listContainer.innerHTML = `<div class="text-center text-red-400 text-sm py-10">Failed to load content.<br><span class="text-xs opacity-50">Try refreshing the page.</span></div>`;
    }
}

const canvas = document.getElementById('flowCanvas');
const ctx = canvas.getContext && canvas.getContext('2d');
let w,h,particles=[];
function resize(){ if(!canvas) return; w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
function anim(){ if(!ctx) return; ctx.clearRect(0,0,w,h); particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0) p.x=w; if(p.x>w) p.x=0; if(p.y<0) p.y=h; if(p.y>h) p.y=0; ctx.fillStyle='rgba(52, 211, 153, 0.15)'; ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill(); }); requestAnimationFrame(anim); }
if(ctx){ window.addEventListener('resize',resize); resize(); for(let i=0;i<40;i++) particles.push({x:Math.random()* (window.innerWidth||800), y:Math.random()* (window.innerHeight||600), vx:(Math.random()-0.5)*0.3, vy:(Math.random()-0.5)*0.3, s:Math.random()*2}); anim(); }

loadData();
</script>
</body>
</html>