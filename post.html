<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HDIPERS.LOG | Loading...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700;900&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
        window.runMermaid = async () => {
            await mermaid.run({ querySelector: '.mermaid' });
        };
    </script>
    
    <style>
        :root{--bg:#0a0a0a; --text:#e5e5e5; --accent:#facc15;}
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow-x: hidden;}
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-cn { font-family: 'Noto Serif SC', serif; }
        
        /* 文章排版样式 */
        .prose { max-width: none; }
        .prose h1, .prose h2, .prose h3 { color: #fff; margin-top: 2.5em; margin-bottom: 0.8em; font-weight: 800; line-height: 1.2; }
        .prose h1 { font-size: 2.5rem; border-bottom: 2px solid var(--accent); padding-bottom: 0.3em; display: inline-block; }
        .prose h2 { font-size: 1.8rem; color: var(--accent); }
        .prose h3 { font-size: 1.4rem; color: #fbbf24; }
        .prose p { margin-bottom: 1.5em; line-height: 1.8; opacity: 0.9; font-size: 1.05rem; }
        .prose ul, .prose ol { margin-bottom: 1.5em; padding-left: 1.5em; }
        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }
        .prose li { margin-bottom: 0.5em; }
        
        /* 代码块样式 */
        .prose pre { 
            background: #171717 !important; 
            border: 1px solid #333; 
            border-radius: 6px; 
            padding: 1.2em; 
            overflow-x: auto; 
            font-family: 'JetBrains Mono', monospace;
            margin: 1.5em 0;
        }
        .prose code { 
            font-family: 'JetBrains Mono', monospace; 
            background: rgba(255,255,255,0.1); 
            padding: 0.2em 0.4em; 
            border-radius: 4px; 
            font-size: 0.9em; 
            color: var(--accent);
        }
        .prose pre code { background: transparent; padding: 0; color: inherit; }
        
        /* 引用块样式 */
        .prose blockquote { 
            border-left: 4px solid var(--accent); 
            background: rgba(250, 204, 21, 0.05);
            padding: 1em 1.5em; 
            color: #d4d4d4; 
            font-style: italic; 
            margin: 2em 0;
        }
        
        /* 图片与图表 */
        .prose img { border-radius: 8px; border: 1px solid #333; margin: 2rem auto; max-width: 100%; display: block; }
        .mermaid { background: #171717; padding: 20px; border-radius: 8px; text-align: center; margin: 2rem 0; border: 1px solid #333; }
        
        /* 表格样式 */
        .prose table { width: 100%; border-collapse: collapse; margin: 2em 0; }
        .prose th, .prose td { border: 1px solid #333; padding: 0.75em; text-align: left; }
        .prose th { background: #262626; color: var(--accent); }
    </style>
</head>
<body class="antialiased selection:bg-yellow-500 selection:text-black">

<nav class="fixed top-0 w-full p-6 flex justify-between items-center z-50 backdrop-blur-md bg-black/80 border-b border-white/10">
    <a href="index.html" class="font-bold tracking-tighter text-xl font-mono hover:text-yellow-400 transition">HDIPERS<span class="text-yellow-500">.LOG</span></a>
    <button id="langToggle" class="text-xs font-mono border border-white/20 px-3 py-1 rounded hover:bg-white/10 transition uppercase">CN / EN</button>
</nav>

<main class="max-w-4xl mx-auto px-6 py-32 min-h-screen">
    <header class="mb-16 border-b border-neutral-800 pb-8">
        <h1 id="post-title" class="text-3xl md:text-5xl font-black mb-6 leading-tight text-white tracking-tight">
            Loading System Log...
        </h1>
        <div class="flex flex-wrap gap-4 text-xs font-mono text-neutral-500 uppercase tracking-widest">
            <span id="post-date">...</span>
            <span id="post-tags"></span>
        </div>
    </header>

    <article id="post-body" class="prose">
        <div class="flex flex-col items-center justify-center py-20 opacity-50 space-y-4">
            <div class="w-8 h-8 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="font-mono text-sm">ACCESSING DATABASE...</p>
        </div>
    </article>
</main>

<footer class="w-full text-center opacity-30 text-xs font-mono uppercase tracking-widest pb-8">
    22abad @ Ireland // END OF LOG
</footer>

<script>
    // ⚡️ 核心配置 ⚡️
    const GITHUB_USERNAME = '22abad'; 
    const GITHUB_REPO = 'hdipersNotes'; // 确保这里大小写和 GitHub 仓库完全一致
    const POSTS_FOLDER = 'posts';

    const toggleBtn = document.getElementById('langToggle');
    let isEnglish = true;

    function updateLang() {
        document.querySelectorAll('.content-en').forEach(el => el.classList.toggle('hidden', !isEnglish));
        document.querySelectorAll('.content-zh').forEach(el => el.classList.toggle('hidden', isEnglish));
        toggleBtn.textContent = isEnglish ? 'SWITCH TO 中文' : 'SWITCH TO ENGLISH';
    }
    toggleBtn.addEventListener('click', ()=>{ isEnglish = !isEnglish; updateLang(); });

    function getQueryParam(name) { return new URLSearchParams(window.location.search).get(name); }

    function parseFrontMatter(raw){
        const result = {meta:{}, body: raw};
        const m = raw.match(/^---\s*([\s\S]*?)\s*---\s*/);
        if(!m) return result;
        const lines = m[1].split('\n');
        lines.forEach(line => {
            const split = line.indexOf(':');
            if(split > 0) result.meta[line.slice(0,split).trim()] = line.slice(split+1).trim();
        });
        result.body = raw.slice(m[0].length);
        return result;
    }

    async function loadPost(){
        const filename = getQueryParam('id');
        if(!filename) {
            window.location.href = 'index.html';
            return;
        }
        
        try {
            // 使用 GitHub API 读取内容
            const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${POSTS_FOLDER}/${filename}.md`;
            console.log("Fetching:", url); // Debug Log

            const res = await fetch(url);
            
            if(!res.ok) {
                if(res.status === 404) throw new Error("File not found in repository (404)");
                throw new Error(`GitHub API Error: ${res.status}`);
            }
            
            const json = await res.json();
            // 解码 Base64 内容 (支持中文)
            const rawText = decodeURIComponent(escape(window.atob(json.content)));
            
            const data = parseFrontMatter(rawText);

            // 更新标题
            document.title = (data.meta.title || 'Log') + ' | HDIPERS';
            document.getElementById('post-title').innerHTML = `
                <span class="content-en block">${data.meta.title_en || data.meta.title}</span>
                <span class="content-zh hidden font-cn block mt-2 text-2xl md:text-4xl opacity-90">${data.meta.title_zh || data.meta.title}</span>
            `;
            document.getElementById('post-date').textContent = data.meta.date || 'UNKNOWN DATE';

            // 更新标签
            if(data.meta.tags) {
                const tags = data.meta.tags.split(',').map(t => t.trim());
                const tagContainer = document.getElementById('post-tags');
                tagContainer.innerHTML = tags.map(t => `<span class="border border-neutral-700 px-1 rounded">#${t}</span>`).join(' ');
            }

            // 配置 Marked 渲染器
            const renderer = new marked.Renderer();
            
            // 自定义代码块渲染 (支持 Mermaid)
            renderer.code = function(code, language) {
                if (language === 'mermaid') {
                    return `<div class="mermaid">${code}</div>`;
                }
                const validLang = Prism.languages[language] ? language : 'plaintext';
                return `<pre><code class="language-${validLang}">${code}</code></pre>`;
            };
            
            // 自定义图片渲染 (处理 GitHub 相对路径)
            renderer.image = function(href, title, text) {
                // 如果是相对路径 (images/...)，转换成 GitHub Raw 链接
                if (!href.startsWith('http')) {
                    const rawUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/${href}`;
                    return `<img src="${rawUrl}" alt="${text}" title="${title || ''}" />`;
                }
                return `<img src="${href}" alt="${text}" title="${title || ''}" />`;
            };

            const rawHTML = marked.parse(data.body, { renderer: renderer });
            
            // 处理双语标签
            let processedHTML = rawHTML
                .replace(/\[EN\]([\s\S]*?)\[END\]/g, '<div class="content-en">$1</div>')
                .replace(/\[ZH\]([\s\S]*?)\[END\]/g, '<div class="content-zh hidden font-cn">$1</div>');

            document.getElementById('post-body').innerHTML = processedHTML;
            
            updateLang();
            if(window.Prism) Prism.highlightAll();
            if(window.runMermaid) window.runMermaid();

        } catch(e) {
            console.error(e);
            document.getElementById('post-body').innerHTML = `
                <div class="border border-red-900 bg-red-900/20 p-8 rounded text-center">
                    <h3 class="text-red-500 font-bold text-xl mb-2">SYSTEM ERROR</h3>
                    <p class="font-mono text-sm text-red-300 mb-4">${e.message}</p>
                    <p class="text-xs text-neutral-500">Check console logs (F12) for details.</p>
                    <a href="index.html" class="inline-block mt-6 border border-neutral-600 px-4 py-2 rounded hover:bg-neutral-800 transition text-sm">RETURN TO INDEX</a>
                </div>`;
        }
    }
    loadPost();
</script>
</body>
</html>